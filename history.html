<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Eze Supermarket ‚Äì History</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{box-sizing:border-box;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;}
:root{--blue:#007bff;--bg:#f5f7fb;--card:#fff;--text:#333;}
body{margin:0;min-height:100vh;background:var(--bg);color:var(--text);transition:.3s;}
body.dark{--bg:#111216;--card:#1f2124;--text:#eaeaea;}
header{background:var(--blue);color:#fff;padding:14px;display:flex;align-items:center;justify-content:space-between;}
header h1{margin:0;font-size:18px;}
.balance{font-weight:600;}
.hamburger{font-size:22px;cursor:pointer;background:none;border:none;color:#fff;margin-right:12px;}
nav{position:fixed;top:0;left:-260px;width:240px;height:100%;background:var(--card);box-shadow:2px 0 6px rgba(0,0,0,.2);padding:20px;transition:.3s;z-index:1200;}
nav.active{left:0;}
nav h2{margin:0 0 16px;color:var(--blue);}
nav ul{list-style:none;padding:0;margin:0;}
nav li{margin-bottom:12px;}
nav a{text-decoration:none;color:inherit;display:block;padding:8px;border-radius:6px;}
nav a:hover{background:var(--blue);color:#fff;}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1100;}
.overlay.active{display:block;}
main{flex:1;padding:20px;margin-top:10px;}
h2{color:var(--blue);margin-top:0;}
.history-card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:12px;position:relative;}
body.dark .history-card{background:#2b2b2b;color:#eee;}
.history-card h3{margin:0 0 6px;font-size:16px;}
.history-card p{margin:0 0 4px;font-size:14px;}
.items-list{padding-left:18px;margin:0 0 6px;}
.history-card button{position:absolute;top:10px;right:10px;padding:4px 8px;border:none;background:red;color:#fff;border-radius:6px;cursor:pointer;}
.history-card button:hover{opacity:.85;}
.download-btn{position:absolute;top:10px;right:80px;padding:4px 8px;background:var(--blue);color:#fff;border:none;border-radius:6px;cursor:pointer;}
.download-btn:hover{opacity:.9;}
.qr{margin-top:8px;text-align:center;}
</style>
</head>
<body>

<div class="overlay" id="overlay"></div>

<nav id="sidebar">
<h2>Menu</h2>
<ul>
<li><a href="dashboard.html">üè† Dashboard</a></li>
<li><a href="profile.html">üë§ Profile</a></li>
<li><a href="add-money.html">üí≥ Add Money</a></li>
<li><a href="cart.html">üõí Cart</a></li>
<li><a href="products.html">üì¶ Products</a></li>
<li><a href="receipts.html">üßæ Receipts</a></li>
<li><a href="history.html" class="active">üìä History</a></li>
</ul>
</nav>

<header>
<div style="display:flex;align-items:center;">
<button class="hamburger" id="menuBtn">‚ò∞</button>
<h1>History</h1>
</div>
<div class="balance">Balance: ‚Ç¶<span id="balance">0</span></div>
</header>

<main>
<h2>Your Transaction & Purchase History</h2>
<div id="historyContainer"></div>
</main>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const $ = id=>document.getElementById(id);

// Hamburger
const menuBtn=$('menuBtn'), sidebar=$('sidebar'), overlay=$('overlay');
menuBtn.onclick=()=>{sidebar.classList.add('active'); overlay.classList.add('active');};
overlay.onclick=()=>{sidebar.classList.remove('active'); overlay.classList.remove('active');};
document.querySelectorAll('#sidebar a').forEach(a=>a.addEventListener('click',()=>{sidebar.classList.remove('active'); overlay.classList.remove('active');}));

// User & balance
let activeUser = JSON.parse(localStorage.getItem('activeUser')||'{}');
if(!activeUser.email) location.href='login.html';
$('balance').textContent = Number(activeUser.balance||0).toLocaleString();

// Get user-specific history
let transactions = JSON.parse(localStorage.getItem('transactions')||'[]').filter(t=>t.user===activeUser.email);
let purchases = JSON.parse(localStorage.getItem('history')||'[]').filter(p=>p.user===activeUser.email);

const historyContainer = $('historyContainer');

function renderHistory(){
    historyContainer.innerHTML='';
    if(transactions.length===0 && purchases.length===0){
        historyContainer.innerHTML='<p>No history yet.</p>';
        return;
    }

    // Top-up transactions
    transactions.slice().reverse().forEach(txn=>{
        const card = document.createElement('div');
        card.className='history-card';
        card.innerHTML=`
            <h3>Top-up: ‚Ç¶${Number(txn.amount).toLocaleString()}</h3>
            <p><strong>Method:</strong> ${txn.method}</p>
            <p><strong>Reference:</strong> ${txn.reference}</p>
            <p><strong>Date:</strong> ${txn.time}</p>
        `;
        // Delete
        const delBtn = document.createElement('button');
        delBtn.textContent='Delete';
        delBtn.onclick=()=>{
            if(confirm('Delete this transaction?')){
                transactions = transactions.filter(t=>t.id!==txn.id);
                localStorage.setItem('transactions',JSON.stringify([...transactions, ...JSON.parse(localStorage.getItem('transactions')||'[]').filter(t=>t.user!==activeUser.email)]));
                renderHistory();
            }
        };
        // Download
        const downloadBtn = document.createElement('button');
        downloadBtn.textContent='Download';
        downloadBtn.className='download-btn';
        downloadBtn.onclick=()=>{
            html2canvas(card).then(canvas=>{
                const link = document.createElement('a');
                link.download = `topup_${txn.id}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        };
        card.appendChild(delBtn);
        card.appendChild(downloadBtn);
        historyContainer.appendChild(card);
    });

    // Purchases
    purchases.slice().reverse().forEach(p=>{
        const card = document.createElement('div');
        card.className='history-card';
        let itemsHTML = '<ul class="items-list">'+p.items.map(i=>`<li>${i.name} x ${i.qty} = ‚Ç¶${(i.price*i.qty).toLocaleString()}</li>`).join('')+'</ul>';
        card.innerHTML=`
            <h3>Purchase: ‚Ç¶${p.total.toLocaleString()}</h3>
            ${itemsHTML}
            <p><strong>Date:</strong> ${p.date}</p>
            <div class="qr" id="qr_${p.id}"></div>
        `;
        // Generate QR code
        QRCode.toCanvas(document.getElementById(`qr_${p.id}`), JSON.stringify({
            user: activeUser.email,
            total: p.total,
            date: p.date,
            items: p.items
        }), {width:100}, function (error) {
            if (error) console.error(error);
        });

        // Delete
        const delBtn = document.createElement('button');
        delBtn.textContent='Delete';
        delBtn.onclick=()=>{
            if(confirm('Delete this purchase?')){
                purchases = purchases.filter(x=>x.id!==p.id);
                localStorage.setItem('history',JSON.stringify([...purchases, ...JSON.parse(localStorage.getItem('history')||'[]').filter(x=>x.user!==activeUser.email)]));
                renderHistory();
            }
        };
        // Download
        const downloadBtn = document.createElement('button');
        downloadBtn.textContent='Download';
        downloadBtn.className='download-btn';
        downloadBtn.onclick=()=>{
            html2canvas(card).then(canvas=>{
                const link = document.createElement('a');
                link.download = `purchase_${p.id}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        };
        card.appendChild(delBtn);
        card.appendChild(downloadBtn);
        historyContainer.appendChild(card);
    });
}

renderHistory();

// Dark mode sync
const theme = localStorage.getItem('theme');
if(theme==='dark') document.body.classList.add('dark');
window.addEventListener('storage',e=>{if(e.key==='theme') document.body.classList.toggle('dark', localStorage.getItem('theme')==='dark');});
</script>
</body>
</html>